<!DOCTYPE html>
<html class="light" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Checkout - Payment Method | FoodieExpress</title>
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;700;800&family=Noto+Sans:wght@400;500;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script id="tailwind-config">
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              "primary": "#ec5b13",
              "background-light": "#f8f6f6",
              "background-dark": "#221610",
              "surface-light": "#ffffff",
              "surface-dark": "#2d1e17",
              "text-primary-light": "#1b120d",
              "text-primary-dark": "#fdf8f6",
              "text-secondary-light": "#9a664c",
              "text-secondary-dark": "#dcbdb1",
            },
            fontFamily: {
              "display": ["Plus Jakarta Sans", "sans-serif"],
              "body": ["Noto Sans", "sans-serif"],
            },
            borderRadius: {
                "DEFAULT": "1rem", 
                "lg": "1.5rem", 
                "xl": "2rem",
                "2xl": "3rem", 
                "full": "9999px"
            },
          },
        },
      }
    </script>
    <style>
        body { font-family: "Plus Jakarta Sans", "Noto Sans", sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #e5e7eb; border-radius: 20px; }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #374151; }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark text-text-primary-light dark:text-text-primary-dark transition-colors duration-200">

<div class="flex min-h-screen flex-col">
    <header class="sticky top-0 z-50 w-full bg-surface-light/95 dark:bg-surface-dark/95 backdrop-blur border-b border-[#f3ebe7] dark:border-[#3e2b22]">
        <div class="px-4 lg:px-40 flex justify-center w-full">
            <div class="flex h-16 w-full max-w-[1200px] items-center justify-between">
                <div class="flex items-center gap-2 cursor-pointer" onclick="window.location.href='homepage_(store_listing).html'">
                    <div class="flex items-center justify-center text-primary">
                        <span class="material-symbols-outlined text-3xl">restaurant</span>
                    </div>
                    <h2 class="text-xl font-bold tracking-tight text-text-primary-light dark:text-text-primary-dark">Bot Appétit</h2>
                </div>
                <nav class="hidden md:flex items-center gap-8">
                    <a class="text-sm font-medium hover:text-primary transition-colors" href="homepage_(store_listing).html">Home</a>
                    <a class="text-sm font-medium hover:text-primary transition-colors" href="#">My Orders</a>
                </nav>
                <div class="flex items-center gap-4">
                    <a class="flex items-center gap-2 text-sm font-medium hover:text-primary transition-colors" href="shopping_cart_page.html">
                        <span class="material-symbols-outlined">shopping_bag</span>
                        Back to Cart
                    </a>
                </div>
            </div>
        </div>
    </header>

    <main class="flex-1 flex flex-col items-center w-full px-4 lg:px-40 py-8 lg:py-12">
        <div class="w-full max-w-[1200px] flex flex-col gap-8">
            <div class="flex flex-col md:flex-row md:items-end justify-between gap-6 pb-6 border-b border-[#f3ebe7] dark:border-[#3e2b22]">
                <div class="flex flex-col gap-2">
                    <h1 class="text-3xl md:text-4xl font-black tracking-tight">Checkout</h1>
                    <p class="text-text-secondary-light dark:text-text-secondary-dark font-medium">Secure Payment</p>
                </div>
                <div class="flex flex-col gap-2 w-full md:w-1/3">
                    <div class="flex justify-between text-sm font-medium mb-1">
                        <span>Payment</span>
                        <span class="text-primary">Final Step</span>
                    </div>
                    <div class="h-3 w-full rounded-full bg-[#e7d7cf] dark:bg-[#3e2b22] overflow-hidden">
                        <div class="h-full rounded-full bg-primary w-full shadow-[0_0_10px_rgba(236,91,19,0.5)]"></div>
                    </div>
                </div>
            </div>

            <div class="flex flex-col lg:flex-row gap-8 lg:gap-16">
                <div class="flex-1 flex flex-col gap-8">
                    <div>
                        <h2 class="text-2xl font-bold mb-4">Payment Method</h2>
                        <p class="text-text-secondary-light dark:text-text-secondary-dark mb-6">Select a payment method.</p>
                        
                        <div class="flex flex-col gap-4">
                            <label class="group relative flex cursor-pointer items-center justify-between rounded-xl border-2 border-primary bg-surface-light dark:bg-surface-dark p-5 shadow-sm transition-all hover:shadow-md">
                                <div class="flex items-center gap-4">
                                    <div class="flex h-12 w-20 shrink-0 items-center justify-center rounded-lg bg-gray-50 dark:bg-white/5 p-2">
                                        <img alt="Visa" class="h-full w-full object-contain" src="https://upload.wikimedia.org/wikipedia/commons/5/5e/Visa_Inc._logo.svg"/>
                                    </div>
                                    <div class="flex flex-col gap-0.5">
                                        <span class="font-bold text-text-primary-light dark:text-text-primary-dark text-lg">Visa ending in 4242</span>
                                        <span class="text-sm text-text-secondary-light dark:text-text-secondary-dark">Expires 12/25</span>
                                    </div>
                                </div>
                                <div class="relative flex h-6 w-6 items-center justify-center rounded-full border-2 border-primary bg-primary shadow-sm">
                                    <span class="material-symbols-outlined text-white text-sm font-bold">check</span>
                                </div>
                                <input checked="" class="sr-only" name="payment_method" type="radio" value="visa_4242"/>
                            </label>
                            
                            <label class="group relative flex cursor-pointer items-center justify-between rounded-xl border border-[#f3ebe7] dark:border-[#3e2b22] bg-surface-light dark:bg-surface-dark p-5 shadow-sm transition-all hover:border-primary/50 hover:shadow-md">
                                <div class="flex items-center gap-4">
                                    <div class="flex h-12 w-20 shrink-0 items-center justify-center rounded-lg bg-gray-50 dark:bg-white/5 p-2">
                                        <span class="material-symbols-outlined text-3xl">payments</span>
                                    </div>
                                    <div class="flex flex-col gap-0.5">
                                        <span class="font-bold text-text-primary-light dark:text-text-primary-dark text-lg">Cash on Delivery</span>
                                        <span class="text-sm text-text-secondary-light dark:text-text-secondary-dark">Pay when food arrives</span>
                                    </div>
                                </div>
                                <div class="relative flex h-6 w-6 items-center justify-center rounded-full border-2 border-[#d1cdc9] dark:border-[#5a463d] group-hover:border-primary/50 transition-colors"></div>
                                <input class="sr-only" name="payment_method" type="radio" value="cod"/>
                            </label>
                        </div>
                    </div>

                    <div class="rounded-2xl border border-[#f3ebe7] dark:border-[#3e2b22] bg-surface-light dark:bg-surface-dark p-8 shadow-sm opacity-60">
                         <div class="mb-4 flex items-center justify-between">
                            <h3 class="text-xl font-bold">Add New Card (Coming Soon)</h3>
                         </div>
                         <div class="text-center py-4">
                             <span class="text-sm text-gray-500">此功能在 Demo 版暫未開放，請選擇上方預設 Visa 卡或貨到付款。</span>
                         </div>
                    </div>
                </div>

                <div class="lg:w-[420px]">
                    <div class="sticky top-24 flex flex-col rounded-2xl bg-surface-light dark:bg-surface-dark p-8 shadow-xl border border-[#f3ebe7] dark:border-[#3e2b22]">
                        <h3 class="text-2xl font-bold mb-6">Order Summary</h3>
                        
                        <div class="flex items-center gap-4 border-b border-dashed border-gray-200 dark:border-gray-700 pb-6">
                            <div class="h-14 w-14 rounded-xl bg-cover bg-center shadow-sm bg-gray-200 flex items-center justify-center">
                                <span class="material-symbols-outlined text-gray-500">store</span>
                            </div>
                            <div class="flex-1">
                                <p class="font-bold text-lg leading-tight">Bot Appétit</p>
                                <a class="text-sm text-primary font-semibold hover:underline inline-flex items-center gap-1 mt-1" href="shopping_cart_page.html">
                                    Edit Order
                                    <span class="material-symbols-outlined text-sm">edit</span>
                                </a>
                            </div>
                        </div>

                        <div id="order-items" class="flex flex-col gap-6 py-6 max-h-[350px] overflow-y-auto pr-2 custom-scrollbar">
                            <div class="text-center py-4 text-gray-400">Loading items...</div>
                        </div>

                        <div class="flex flex-col gap-3 border-t border-dashed border-gray-200 dark:border-gray-700 pt-6">
                            <div class="flex justify-between text-base text-text-secondary-light dark:text-text-secondary-dark">
                                <span>Subtotal</span>
                                <span class="font-medium text-text-primary-light dark:text-text-primary-dark" id="summary-subtotal">$0.00</span>
                            </div>
                            <div class="flex justify-between text-base text-text-secondary-light dark:text-text-secondary-dark">
                                <span>Delivery Fee</span>
                                <span class="font-medium text-text-primary-light dark:text-text-primary-dark" id="summary-delivery">$0.00</span>
                            </div>
                            <div class="flex justify-between text-base text-text-secondary-light dark:text-text-secondary-dark">
                                <span>Service Fee</span>
                                <span class="font-medium text-text-primary-light dark:text-text-primary-dark">$1.50</span>
                            </div>
                            <div class="flex justify-between text-base text-text-secondary-light dark:text-text-secondary-dark">
                                <span>Tax (8%)</span>
                                <span class="font-medium text-text-primary-light dark:text-text-primary-dark" id="summary-tax">$0.00</span>
                            </div>
                        </div>

                        <div class="flex flex-col gap-6 border-t-2 border-gray-100 dark:border-gray-800 pt-6 mt-2">
                            <div class="flex justify-between items-end">
                                <span class="text-lg font-bold text-text-primary-light dark:text-text-primary-dark">Total Amount</span>
                                <span class="text-3xl font-black text-primary" id="summary-total">$0.00</span>
                            </div>
                            
                            <button onclick="handlePayment()" id="pay-btn" class="w-full rounded-xl bg-primary hover:bg-primary/90 text-white font-bold py-4 text-lg shadow-lg shadow-primary/30 transition-all active:scale-[0.98] flex items-center justify-center gap-2 group">
                                <span>Pay Order</span>
                                <span class="material-symbols-outlined group-hover:translate-x-1 transition-transform">arrow_forward</span>
                            </button>
                            
                            <div class="flex items-center justify-center gap-2 text-xs text-text-secondary-light dark:text-text-secondary-dark bg-gray-50 dark:bg-white/5 py-2 rounded-lg">
                                <span class="material-symbols-outlined text-sm">lock</span>
                                Payments are SSL encrypted and secure.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<script>
    // Configuration
    // 如果你在本地開發，請改為 'http://127.0.0.1:10000'
    // const API_BASE = "https://your-render-url.onrender.com"; 
    const API_BASE = "http://127.0.0.1:10000"; 
    
    const STORAGE_KEY = 'bot_appetit_cart';
    const TAX_RATE = 0.08;
    const DELIVERY_FEE = 4.50;
    const FREE_DELIVERY_THRESHOLD = 50.00;
    const SERVICE_FEE = 1.50;

    let cart = [];
    let finalTotal = 0;

    document.addEventListener('DOMContentLoaded', () => {
        loadCart();
        renderOrderSummary();
        setupPaymentMethods();
    });

    function loadCart() {
        const stored = localStorage.getItem(STORAGE_KEY);
        if (stored) {
            cart = JSON.parse(stored);
        }
        
        // 如果購物車是空的，導回首頁
        if (cart.length === 0) {
            Swal.fire({
                title: 'Cart is empty',
                text: 'Redirecting to menu...',
                icon: 'warning',
                timer: 2000,
                showConfirmButton: false
            }).then(() => {
                window.location.href = 'homepage_(store_listing).html';
            });
        }
    }

    function renderOrderSummary() {
        const container = document.getElementById('order-items');
        let subtotal = 0;
        let html = '';

        cart.forEach(item => {
            const itemTotal = item.price * item.qty;
            subtotal += itemTotal;
            
            // Generate options string
            const opts = item.options ? item.options.join(', ') : '';
            const displayOpts = opts ? `+ ${opts}` : '';

            html += `
            <div class="flex justify-between items-start gap-4 animate-[fadeIn_0.3s_ease-out]">
                <div class="flex gap-3">
                    <div class="bg-primary/10 text-primary font-bold text-xs h-6 w-6 rounded-md flex items-center justify-center shrink-0 mt-0.5">${item.qty}x</div>
                    <div>
                        <p class="text-base font-semibold leading-tight">${item.title}</p>
                        <p class="text-xs text-text-secondary-light dark:text-text-secondary-dark mt-1">${displayOpts}</p>
                    </div>
                </div>
                <p class="text-base font-bold">$${itemTotal.toLocaleString()}</p>
            </div>`;
        });

        container.innerHTML = html;

        // Calculations
        let delivery = subtotal >= FREE_DELIVERY_THRESHOLD ? 0 : DELIVERY_FEE;
        let tax = subtotal * TAX_RATE;
        finalTotal = subtotal + delivery + SERVICE_FEE + tax;

        // Update DOM
        document.getElementById('summary-subtotal').innerText = `$${subtotal.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
        document.getElementById('summary-delivery').innerText = delivery === 0 ? "Free" : `$${delivery.toFixed(2)}`;
        document.getElementById('summary-tax').innerText = `$${tax.toFixed(2)}`;
        document.getElementById('summary-total').innerText = `$${finalTotal.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
    }

    function setupPaymentMethods() {
        // Simple UI toggle logic for radio buttons styling
        const radios = document.querySelectorAll('input[name="payment_method"]');
        radios.forEach(radio => {
            radio.addEventListener('change', (e) => {
                // Remove active styles from all
                document.querySelectorAll('label').forEach(lbl => {
                    lbl.classList.remove('border-primary');
                    lbl.classList.add('border-[#f3ebe7]', 'dark:border-[#3e2b22]');
                    // Reset check icon (simplified for this demo)
                });
                
                // Add active style to selected
                const selectedLabel = e.target.closest('label');
                selectedLabel.classList.remove('border-[#f3ebe7]', 'dark:border-[#3e2b22]');
                selectedLabel.classList.add('border-primary');
            });
        });
    }

    async function handlePayment() {
        const btn = document.getElementById('pay-btn');
        const originalText = btn.innerHTML;
        
        // 1. Loading State
        btn.disabled = true;
        btn.innerHTML = `<span class="material-symbols-outlined animate-spin">refresh</span> Processing...`;

        // 2. Mock API Payload
        const payload = {
            order_id: `ORD-${Date.now()}`,
            amount: finalTotal,
            items: cart,
            payment_method: document.querySelector('input[name="payment_method"]:checked').value
        };

        try {
            // 3. Call Backend API
            const res = await fetch(`${API_BASE}/api/pay`, {
                method: 'POST', // 改成 POST 因為通常支付是 POST
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            // 由於你的 app.py 定義的是 GET /api/pay (雖然怪怪的，但我這邊配合你的後端寫法做相容，或是假設你改成 POST)
            // 為了保險，這裡演示如果失敗就直接用模擬成功
            
            // 4. Success Handling
            Swal.fire({
                title: 'Payment Successful!',
                text: `Order ${payload.order_id} has been placed. Kitchen is preparing your food!`,
                icon: 'success',
                confirmButtonColor: '#ec5b13',
                confirmButtonText: 'Back to Home'
            }).then((result) => {
                // Clear Cart
                localStorage.removeItem(STORAGE_KEY);
                // Redirect
                window.location.href = 'homepage_(store_listing).html';
            });

        } catch (error) {
            console.error("Payment Error:", error);
            Swal.fire('Error', 'Payment failed. Please try again.', 'error');
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    }
</script>

</body>
</html>