<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Party Call</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        body { margin: 0; padding: 0; font-family: sans-serif; background-color: #121212; color: white; height: 100vh; display: flex; flex-direction: column; }
        
        /* ç™»å…¥ä»‹é¢ */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #1a1a1a; z-index: 999; display: flex; flex-direction: column;
            justify-content: center; align-items: center; gap: 20px;
        }
        
        input { padding: 12px; font-size: 18px; text-align: center; border-radius: 8px; border: none; width: 250px; }
        
        .btn-group { display: flex; gap: 15px; }
        
        button {
            padding: 15px 30px; font-size: 16px; cursor: pointer; border: none; border-radius: 8px;
            color: white; font-weight: bold; transition: 0.2s;
        }
        
        .btn-voice { background: #28a745; } /* ç¶ è‰² */
        .btn-voice:hover { background: #218838; }
        
        .btn-screen { background: #007bff; } /* è—è‰² */
        .btn-screen:hover { background: #0056b3; }

        /* ä¸»ç•«é¢ */
        #main-interface { display: none; flex-direction: column; height: 100%; }

        .header {
            padding: 10px 20px; background: rgba(0,0,0,0.5); display: flex; justify-content: space-between; align-items: center;
        }

        /* è¦–è¨Šç¶²æ ¼ï¼šè‡ªå‹•é©æ‡‰äººæ•¸ */
        .video-grid {
            flex-grow: 1;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); /* è‡ªå‹•æ’ç‰ˆ */
            gap: 10px;
            padding: 10px;
            overflow-y: auto;
        }

        .video-card {
            position: relative;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            aspect-ratio: 16/9; /* ä¿æŒæ¯”ä¾‹ */
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            border: 1px solid #333;
        }

        video { width: 100%; height: 100%; object-fit: contain; }

        .label {
            position: absolute; bottom: 10px; left: 10px;
            background: rgba(0,0,0,0.7); padding: 4px 8px;
            border-radius: 4px; font-size: 12px; color: #fff;
        }

        /* è‡ªå·±çš„ç•«é¢é‚Šæ¡†é¡è‰² */
        .local-border { border: 2px solid #007bff !important; }
    </style>
</head>
<body>

    <div id="login-screen">
        <h2>WebRTC å¤šäººé€šè©±</h2>
        <input id="roomInput" type="text" placeholder="è¼¸å…¥æˆ¿é–“è™Ÿç¢¼ (å¦‚: 101)" value="101">
        <div class="btn-group">
            <button class="btn-voice" onclick="startApp('voice')">ğŸ¤ èªéŸ³åŠ å…¥</button>
            <button class="btn-screen" onclick="startApp('screen')">ğŸ–¥ï¸ ç›´æ’­è¢å¹• + èªéŸ³</button>
        </div>
    </div>

    <div id="main-interface">
        <div class="header">
            <span id="status">Status: Connected</span>
            <span id="room-display">Room: -</span>
        </div>
        <div class="video-grid" id="videoGrid">
            </div>
    </div>

    <script>
        const socket = io({ autoConnect: false }); // å…ˆä¸é€£ç·šï¼Œç­‰é¸å¥½æ¨¡å¼
        
        let localStream;
        let peers = {}; 
        let myId = null;
        
        const rtcConfig = {
            iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] 
        };

        // 1. å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼
        async function startApp(mode) {
            const room = document.getElementById('roomInput').value;
            if (!room) return alert("è«‹è¼¸å…¥æˆ¿é–“è™Ÿç¢¼");

            try {
                // æ ¹æ“šæ¨¡å¼å–å¾—ä¸²æµ
                if (mode === 'voice') {
                    localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
                } else {
                    // è¢å¹• + éº¥å…‹é¢¨
                    const screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: false });
                    const micStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
                    
                    // åˆä½µè»Œé“
                    localStream = new MediaStream([
                        ...screenStream.getVideoTracks(),
                        ...micStream.getAudioTracks()
                    ]);
                }

                // é¡¯ç¤ºä»‹é¢
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-interface').style.display = 'flex';
                document.getElementById('room-display').innerText = `Room: ${room}`;
                
                // é¡¯ç¤ºè‡ªå·±çš„ç•«é¢
                addVideoCard('local', localStream, true);

                // é€£ç·šåˆ°ä¼ºæœå™¨
                socket.connect();
                socket.emit('join', room);

            } catch (err) {
                console.error(err);
                alert("ç„¡æ³•å–å¾—è¨­å‚™æ¬Šé™ï¼š" + err.message);
            }
        }

        // 2. Socket äº‹ä»¶ç›£è½
        socket.on('connect', () => {
            myId = socket.id;
            document.getElementById('status').innerText = "Status: Online (ID: " + myId.substr(0,4) + ")";
        });

        // ç•¶æœ‰äººæ–°åŠ å…¥ï¼šæˆ‘(èˆŠäºº)ä¸»å‹•æ‰“é›»è©±çµ¦ä»–
        socket.on('user-connected', (userId) => {
            console.log("New user connected:", userId);
            connectToNewUser(userId);
        });

        // ç•¶æœ‰äººé›¢é–‹
        socket.on('user-disconnected', (userId) => {
            if (peers[userId]) {
                peers[userId].close();
                delete peers[userId];
            }
            removeVideoCard(userId);
        });

        // æ¥æ”¶ Offer (æ–°äººæ‰“çµ¦æˆ‘)
        socket.on('offer', async (data) => {
            const pc = createPeerConnection(data.from);
            peers[data.from] = pc;
            await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            socket.emit('answer', { answer: answer, to: data.from });
        });

        // æ¥æ”¶ Answer (æˆ‘æ‰“çµ¦æ–°äººï¼Œä»–å›è¦†äº†)
        socket.on('answer', async (data) => {
            const pc = peers[data.from];
            if (pc) {
                await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
            }
        });

        // æ¥æ”¶ ICE Candidate (ç¶²è·¯è·¯å¾‘äº¤æ›)
        socket.on('candidate', async (data) => {
            const pc = peers[data.from];
            if (pc) {
                await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
            }
        });

        // 3. WebRTC æ ¸å¿ƒé‚è¼¯
        function createPeerConnection(userId) {
            const pc = new RTCPeerConnection(rtcConfig);

            // ç•¶ç™¼ç¾ç¶²è·¯è·¯å¾‘æ™‚ï¼Œå‚³çµ¦å°æ–¹
            pc.onicecandidate = (event) => {
                if (event.candidate) {
                    socket.emit('candidate', { candidate: event.candidate, to: userId });
                }
            };

            // ç•¶æ”¶åˆ°å°æ–¹çš„å½±åƒ/è²éŸ³æ™‚
            pc.ontrack = (event) => {
                // ç¢ºä¿åªæ–°å¢ä¸€æ¬¡
                if (!document.getElementById(`video-${userId}`)) {
                    addVideoCard(userId, event.streams[0], false);
                }
            };

            // å°‡æˆ‘è‡ªå·±çš„ç•«é¢/è²éŸ³åŠ å…¥é€£ç·š
            if (localStream) {
                localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
            }

            return pc;
        }

        // ä¸»å‹•ç™¼èµ·é€£ç·š
        async function connectToNewUser(userId) {
            const pc = createPeerConnection(userId);
            peers[userId] = pc;
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            socket.emit('offer', { offer: offer, to: userId });
        }

        // 4. UI è¼”åŠ©å‡½å¼
        function addVideoCard(userId, stream, isLocal) {
            const grid = document.getElementById('videoGrid');
            
            // å¦‚æœå·²ç¶“å­˜åœ¨å°±ç§»é™¤èˆŠçš„ (é¿å…é‡è¤‡)
            removeVideoCard(userId);

            const card = document.createElement('div');
            card.className = `video-card ${isLocal ? 'local-border' : ''}`;
            card.id = `card-${userId}`;

            const video = document.createElement('video');
            video.id = `video-${userId}`;
            video.autoplay = true;
            video.playsInline = true;
            video.srcObject = stream;
            
            // âš ï¸ é‡è¦ï¼šå¦‚æœæ˜¯è‡ªå·±ï¼Œä¸€å®šè¦éœéŸ³ï¼Œå¦å‰‡æœƒå›éŸ³å˜¯å«
            // å¦‚æœæ˜¯åˆ¥äººï¼Œä¸€å®šä¸èƒ½éœéŸ³ (muted=false)
            if (isLocal) {
                video.muted = true;
            }

            const label = document.createElement('div');
            label.className = 'label';
            label.innerText = isLocal ? "Me" : `User ${userId.substr(0,4)}`;

            card.appendChild(video);
            card.appendChild(label);
            grid.appendChild(card);
        }

        function removeVideoCard(userId) {
            const card = document.getElementById(`card-${userId}`);
            if (card) card.remove();
        }
    </script>
</body>
</html>